PLAYGROUND.Transitions = function(app) {

	this.app = app;

	app.on("enterstate", this.enterstate.bind(this));
	app.on("postrender", this.postrender.bind(this));
	app.on("step", this.step.bind(this));

	this.progress = 1;
	this.lifetime = 0;
};

PLAYGROUND.Transitions.plugin = true;

PLAYGROUND.Transitions.prototype = {

	enterstate: function(data) {

		this.screenshot = this.app.layer.cache();

		if (data.prev) {
			this.lifetime = 0;
			this.progress = 0;
		}

	},

	postrender: function() {

		if (this.progress >= 1) return;

		PLAYGROUND.Transitions.Explode(this, this.progress);

	},

	step: function(delta) {

		if (this.progress >= 1) return;

		this.lifetime += delta;

		this.progress = Math.min(this.lifetime, 1);

	}

};

PLAYGROUND.Transitions.Implode = function(manager, progress) {

	var app = manager.app;
	var layer = app.layer;

	progress = app.ease(progress, "outCubic");

	var negative = 1 - progress;

	layer.save();
	layer.tars(app.center.x, app.center.y, 0.5, 0.5, 0, 0.5 + 0.5 * negative, negative);
	layer.drawImage(manager.screenshot, 0, 0);

	layer.restore();

};


PLAYGROUND.Transitions.Explode = function(manager, progress) {

	var app = manager.app;
	var layer = app.layer;

	progress = app.ease(progress, "outExpo");

	var scale = 1 + progress * 1;

	
	layer.save();
	layer.a(1-progress);
	layer.tars(app.center.x, app.center.y, 0.5, 0.5, 0, scale, scale);
	layer.drawImage(manager.screenshot, 0, 0);
	layer.fillStyle( 'rgba(255, 255, 255, 0.5)' );
	layer.fillRect( 0, 0, app.width, app.height );
	layer.restore();

};

PLAYGROUND.Transitions.Split = function(manager, progress) {

	var app = manager.app;
	var layer = app.layer;

	progress = app.ease(progress, "inOutCubic");

	var negative = 1 - progress;

	layer.save();

	layer.a(negative).clear("#000").ra();

	layer.drawImage(manager.screenshot, 0, 0, app.width, app.height / 2 | 0, 0, 0, app.width, negative * app.height / 2 | 0);
	layer.drawImage(manager.screenshot, 0, app.height / 2 | 0, app.width, app.height / 2 | 0, 0, app.height / 2 + progress * app.height / 2 + 1 | 0, app.width, Math.max(1, negative * app.height * 0.5 | 0));

	layer.restore();
};
